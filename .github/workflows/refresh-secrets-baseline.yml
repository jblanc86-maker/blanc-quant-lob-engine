name: Refresh Detect-Secrets Baseline

on:
  schedule:
    - cron: "0 3 * * 1" # Weekly Monday 03:00 UTC
  workflow_dispatch:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'

permissions:
  contents: write

jobs:
  refresh-baseline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Ensure we are on a branch (not detached HEAD)
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
        run: |
          # Determine branch name for push (PR: GITHUB_HEAD_REF, push: GITHUB_REF_NAME)
          BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"
          if [ -z "$BRANCH" ]; then
            echo "Could not determine branch name; aborting."
            exit 1
          fi
          echo "Using branch: $BRANCH"
          # Configure git author so commits are valid
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Create/force-checkout branch so HEAD is not detached
          git checkout -B "$BRANCH"
          git status --porcelain --branch
          git branch -avv

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.x'

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Update detect-secrets baseline
        run: |
          detect-secrets scan --exclude-files ".secrets.baseline" > .secrets.baseline.new
          if ! diff -q .secrets.baseline .secrets.baseline.new >/dev/null 2>&1; then
            mv .secrets.baseline.new .secrets.baseline
          else
            echo "No baseline changes"
            rm .secrets.baseline.new || true
          fi

      - name: Commit and push changes
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
        run: |
          BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"
          if git status --porcelain | grep .; then
            git add -A
            git commit -m "chore: refresh detect-secrets baseline [skip ci]" || echo "No changes to commit"
            git push origin "$BRANCH"
          else
            echo "No changes to commit"
          fi

# SPDX-License-Identifier: BUSL-1.1
name: CI

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'include/**'
      - 'CMakeLists.txt'
      - '.github/workflows/ci.yml'
      - 'tests/**'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'include/**'
      - 'CMakeLists.txt'
      - '.github/workflows/ci.yml'
      - 'tests/**'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual CI run reason'
        required: false
        default: 'manual'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    # permissions block already present, removed duplicate
    name: build • ${{ matrix.os }} • py${{ matrix.python }}
    runs-on: ${{ matrix.os }}
    if: >-
      ${{ !contains(github.event.head_commit.message, '[skip-ci]')
          && (github.event_name != 'pull_request' || !contains(join(github.event.pull_request.labels.*.name), 'docs-only')) }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python: ['3.11']

    steps:
      - name: Checkout
        # actions/checkout@v4
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Set up Python
        # actions/setup-python@v5
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ matrix.python }}

      - name: Toolchain (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libboost-all-dev jq nlohmann-json3-dev zip unzip

      - name: Toolchain (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew update >/dev/null
          brew list --versions ninja  >/dev/null || brew install ninja
          brew list --versions cmake  >/dev/null || brew install cmake
          brew list --versions jq >/dev/null || brew install jq
          brew list --versions nlohmann-json >/dev/null || brew install nlohmann-json
          # Boost is required for program_options; ensure it's installed on macOS runners
          brew list --versions boost >/dev/null || brew install boost
          # Ensure packaging tools are available on macOS runners
          brew list --versions zip >/dev/null || brew install zip
          brew list --versions unzip >/dev/null || brew install unzip

      - name: Pre-commit (lint)
        run: |
          python -m pip install --upgrade pip
          python -m pip install pre-commit ruff codespell detect-secrets
          pre-commit run --all-files

      - name: Configure + Build (Release)
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=ON
          cmake --build build -j

      - name: Run tests
        run: |
          ctest --test-dir build --output-on-failure

      - name: Run Bench (optional)
        run: |
          make bench ART_DIR=artifacts/${{ github.run_id }} || true

      - name: Release package (optional)
        if: always()
        run: |
          # Create release package (script will write into artifacts/release)
          scripts/release_package.sh || echo "release packaging failed or produced no artifacts"
      - name: Parse bench summary
        if: always()
        run: |
          set -euo pipefail
          OUT=artifacts/${{ github.run_id }}/bench.jsonl
          if [ -f "$OUT" ]; then
            line=$(tail -n1 "$OUT")
            p50=$(jq -r '.p50_ms' <<<"$line")
            p95=$(jq -r '.p95_ms' <<<"$line")
            p99=$(jq -r '.p99_ms' <<<"$line")
            echo "bench_p50_ms=$p50" >> $GITHUB_OUTPUT
            echo "bench_p95_ms=$p95" >> $GITHUB_OUTPUT
            echo "bench_p99_ms=$p99" >> $GITHUB_OUTPUT
            echo "$line" > artifacts/${{ github.run_id }}/bench-summary.json
            {
              echo "# Bench summary"
              echo "p50_ms: $p50"
              echo "p95_ms: $p95"
              echo "p99_ms: $p99"
            } >> "$GITHUB_STEP_SUMMARY"
            echo "::notice title=Bench p50::${p50} ms"
            echo "::notice title=Bench p95::${p95} ms"
            echo "::notice title=Bench p99::${p99} ms"
          else
            echo "bench summary not found at $OUT"
          fi

      - name: Upload artifacts (if present)
        # actions/upload-artifact@v4
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: bench-and-bundle-${{ matrix.os }}-${{ github.run_id }}
          path: |
            artifacts/${{ github.run_id }}/bench.jsonl
            artifacts/${{ github.run_id }}/metrics.prom
            artifacts/${{ github.run_id }}/blanc-lob-engine-rc.tar.gz
            artifacts/release/*.zip
            artifacts/release/*.sig
            artifacts/release/manifest.json
            artifacts/release/rights_manifest.json
          if-no-files-found: ignore
    permissions:
      actions: read
      contents: read
      pull-requests: read
      checks: read
      statuses: read
      issues: read

---
# SPDX-License-Identifier: Apache-2.0
name: Determinism
on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'include/**'
      - 'data/golden/**'
      - 'CMakeLists.txt'
      - '.github/workflows/determinism.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'include/**'
      - 'data/golden/**'
      - 'CMakeLists.txt'
      - '.github/workflows/determinism.yml'
  schedule:
    # Weekly instead of daily
    - cron: '0 6 * * 3'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual determinism run reason'
        required: false
        default: 'manual'

jobs:
  verify-golden:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    if: >-
      ${{ !contains(github.event.head_commit.message, '[skip-ci]')
          && (github.event_name != 'pull_request' || !contains(join(github.event.pull_request.labels.*.name), 'docs-only')) }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Normalize environment
        run: |
          # Ensure deterministic environment
          echo "TZ=UTC" >> $GITHUB_ENV
          echo "LANG=C.UTF-8" >> $GITHUB_ENV
          echo "LC_ALL=C.UTF-8" >> $GITHUB_ENV
      - name: Deps
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libboost-all-dev nlohmann-json3-dev unzip zip
      - name: Build (Release + Benchmarks)
        run: |
          set -euxo pipefail
          rm -rf build
          CC=gcc CXX=g++ cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=ON \
            -DBUILD_BENCHMARKS=ON \
            -DCMAKE_CXX_STANDARD=17
          cmake --build build -j$(nproc)

      - name: Verify deterministic replay (2 runs)
        shell: bash
        run: |
          set -euxo pipefail
          ART_DIR=artifacts/${{ github.run_id }}; mkdir -p "$ART_DIR"
          # Run replay twice and capture digest lines
          ./build/bin/replay --input data/golden/itch_1m.bin | tee "$ART_DIR/run1.txt"
          sleep 1
          ./build/bin/replay --input data/golden/itch_1m.bin | tee "$ART_DIR/run2.txt"
          d1=$(grep -m1 -oE 'digest_fnv=[0-9a-fx]+' "$ART_DIR/run1.txt" || true)
          d2=$(grep -m1 -oE 'digest_fnv=[0-9a-fx]+' "$ART_DIR/run2.txt" || true)
          echo "digest1=$d1"; echo "digest2=$d2"
          if [ "$d1" != "$d2" ]; then
            echo "Determinism failure: digests differ" >&2
            echo "--- run1 ---"; cat "$ART_DIR/run1.txt"; echo "--- run2 ---"; cat "$ART_DIR/run2.txt"
            exit 1
          fi
      - name: Run benchmarks and collect artifacts
        shell: bash
        run: |
          set -euxo pipefail
          ART_DIR=artifacts/${{ github.run_id }}; mkdir -p "$ART_DIR"
          # Prefer top-level bench runner if present, else fall back to binary path
          if [ -x scripts/run-benchmarks.sh ]; then
            ./scripts/run-benchmarks.sh | tee "$ART_DIR/blanc_bench.log"
          elif [ -x build/bench/blanc_bench ]; then
            ./build/bench/blanc_bench --benchmark_counters_tabular=true | tee "$ART_DIR/blanc_bench.log"
          elif [ -x build/bin/blanc_bench ]; then
            ./build/bin/blanc_bench --benchmark_counters_tabular=true | tee "$ART_DIR/blanc_bench.log"
          else
            echo "Benchmark runner not found; skipping" | tee "$ART_DIR/blanc_bench.log"
          fi
          # If synthetic generators exist, run minimal synthetic targets (non-failing)
          if [ -x build/bin/gen_synth ]; then
            ./build/bin/gen_synth --mode quick --out "$ART_DIR/synth_quick.bin" || true
          fi
          # Copy any produced benchmark jsonl / metrics if available
          cp -n artifacts/bench.jsonl "$ART_DIR/bench.jsonl" 2>/dev/null || true
          cp -n artifacts/metrics.prom "$ART_DIR/metrics.prom" 2>/dev/null || true

      - name: Parse bench summary (p50/p95/p99)
        if: always()
        run: |
          set -euo pipefail
          OUT=artifacts/${{ github.run_id }}/bench.jsonl
          if [ -f "$OUT" ]; then
            line=$(tail -n1 "$OUT")
            p50=$(jq -r '.p50_ms' <<<"$line")
            p95=$(jq -r '.p95_ms' <<<"$line")
            p99=$(jq -r '.p99_ms' <<<"$line")
            echo "bench_p50_ms=$p50" >> $GITHUB_OUTPUT
            echo "bench_p95_ms=$p95" >> $GITHUB_OUTPUT
            echo "bench_p99_ms=$p99" >> $GITHUB_OUTPUT
            echo "$line" > artifacts/${{ github.run_id }}/bench-summary.json
          else
            echo "bench summary not found at $OUT"
          fi
      - name: Upload artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: determinism-artifacts-${{ github.run_id }}
          path: |
            artifacts/${{ github.run_id }}/**
            artifacts/bench.jsonl
            artifacts/metrics.prom

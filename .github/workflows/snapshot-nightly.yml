name: Snapshot Nightly
on:
  workflow_dispatch: {}
  schedule:
    - cron: '30 6 * * 3' # weekly at 06:30 UTC (Wednesday)

jobs:
  snapshot:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    if: >-
      ${{ !contains(github.event.head_commit.message, '[skip-ci]')
          && (github.event_name != 'pull_request' || !contains(join(github.event.pull_request.labels.*.name), 'docs-only')) }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build zip libboost-all-dev nlohmann-json3-dev
      - name: Build (Release) and tests
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=ON
          cmake --build build -j
      - name: Clean and create test output
        run: |
          rm -rf tests/out || true
          mkdir -p tests/out
      - name: Run snapshot tests
        run: |
          cd build
          ctest --output-on-failure -R book_snapshot || true
          ctest --output-on-failure -R book_snapshot_burst || true
      - name: Upload test artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: snapshot-artifacts-${{ github.run_id }}
          path: tests/out/**

      - name: Create release package
        run: |
          make release-package

      - name: Upload release package
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: release-package-${{ github.run_id }}
          path: artifacts/release/**

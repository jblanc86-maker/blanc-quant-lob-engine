name: Snapshot Nightly
on:
  workflow_dispatch: {}
  schedule:
    - cron: '30 6 * * *' # daily at 06:30 UTC

jobs:
  snapshot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build zip libboost-all-dev nlohmann-json3-dev
      - name: Build (Release) and tests
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=ON
          cmake --build build -j
      - name: Clean and create test output
        run: |
          rm -rf tests/out || true
          mkdir -p tests/out
      - name: Run snapshot tests
        run: |
          cd build
          ctest --output-on-failure -R book_snapshot || true
          ctest --output-on-failure -R book_snapshot_burst || true
      - name: Upload test artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: snapshot-artifacts-${{ github.run_id }}
          path: tests/out/**

      - name: Create release package
        run: |
          make release-package

      - name: Upload release package
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: release-package-${{ github.run_id }}
          path: artifacts/release/**

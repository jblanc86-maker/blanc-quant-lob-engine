name: Snapshot Nightly
on:
  schedule:
    - cron: '30 6 * * *' # daily at 06:30 UTC

jobs:
  snapshot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libboost-all-dev libnlohmann-json3-dev
      - name: Build (Release) and tests
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=ON
          cmake --build build -j
      - name: Clean and create test output
        run: |
          rm -rf tests/out || true
          mkdir -p tests/out
      - name: Run snapshot tests
        run: |
          cd build
          ctest --output-on-failure -R book_snapshot || true
          ctest --output-on-failure -R book_snapshot_burst || true
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-artifacts-${{ github.run_id }}
          path: tests/out/**
